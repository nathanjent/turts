-- title:  Turtle Burgle
-- author: Nathan Jent
-- desc:   We're here to burgle your turts!
-- script: moon

t=0
class Ent
	new:(o)=>
		@x=o and o.x or 96
		@y=o and o.y or 48
		@w=o and o.w or 8
		@h=o and o.h or 8
		@flip=o and o.flip or 0
		@rotate=o and o.rotate or 0
		@scale=o and o.scale or 1
		@sprt={
			id:o and o.sprt and o.sprt.id or 1
			t:o and o.sprt and o.sprt.t or 0
			w:o and o.sprt and o.sprt.w or 1
			h:o and o.sprt and o.sprt.h or 1
		}

behaviors=
	[1]:(player,entities)->
		if btn 0
			player.y-=1
		if btn 1
			player.y+=1
		if btn 2
			player.x-=1
			player.flip=1
		if btn 3
			player.x+=1
			player.flip=0
	[2]:(buddy,entities)->
		p=entities[1]
		sprt=mget((p.x+4)//8,(p.y+10)//8)
		if sprt>0
			buddy.sprt.id=sprt
		buddy.flip=p.flip
		buddy.y=8+p.y+math.sin t/9
		if p.flip==1
			buddy.x=p.x+10
		else
			buddy.x=p.x-10
	[3]:(bullet,entities)->
		if bullet.flip==1
			bullet.x-=2
		else
			bullet.x+=2
		bullet.rotate+=.2
		if bullet.x>240 or bullet.x<0
			table.remove entities,i

entities={
	Ent {
		w:8
		h:16
		sprt:
			id:256
			w:1
			h:2
	}
	Ent {
		sprt:
			id:288
	}
}

-- get flag as byte
fget8=(id)->peek(0x14404+id)

-- set flag as byte
fset8=(id,val)->poke(0x14404+id,val)

draw=(o)->
	spr o.sprt.id,
		o.x,o.y,
		o.sprt.t,o.scale,o.flip,o.rotate,
		o.sprt.w,o.sprt.h

export TIC=->
	for e in entities
		behaviors[fget8(e.sprt.id)](e,entities)


	buddy=entities[2]
	if buddy.sprt.id>0 and btnp 4,15,9
		table.insert entities,Ent {
			x:buddy.x
			y:buddy.y-6
			flip:buddy.flip
			sprt:
				id:fget8(buddy.sprt.id)
		}

	cls!
	map!
	for e in *entities
		draw e

	t+=1

-- <TILES>
-- 001:023333300233333002cf3cf0023333300eddddd00ffffff00eddddd00fe00fe0
-- 002:0000000000000000000000000000006600777066077777600777776000600600
-- 003:09a009a09aaaaaab944aa44b9aaaaaab9dccccdb9dccccdb99aaaaab009aba00
-- 004:008990000899999089999999084a4a4008444443088888830888888388888883
-- 005:0233330023333330334a4a303344443003f7770000f767000f77667000200200
-- 006:0012220001122220034a4a400344444000342400038999400089990000770660
-- 007:0000666000006f60000066440666660066666600077766000003000000033300
-- 016:0000000000000000000000000000000000222066022222663333336006000600
-- 017:0006600060033006063223600322223003222230032222300632236060033006
-- 018:00000000000000000000000000066600706f6f60076555670076667067770776
-- 128:0000000000400000000330400432230000323300000330400040000000000000
-- 130:0000043200004320000032000001100000011000002300000234000023400000
-- 131:c00000c00000c000000000000c0000000000c00000000000000c00000c00000c
-- 132:0040000044444000044400000404000000000400000444440000444000004040
-- 133:00c0eed00c0eeed0c0eeeed00000200000002000000020000000200000002000
-- 134:000000000000cc00000ccbc000ccccbc00cccccc00dccccc00edcccd000eddd0
-- 254:1111111012000210102020101002001010202010120002101111111000000000
-- 255:0ddcccc00dccccc00dffcff00dccfcc00edcccd00ffffff00eddddd00fe00fe0
-- </TILES>

-- <SPRITES>
-- 000:02000000022200002222220022111110214444401444444034cf4cf034444340
-- 016:03444400088999000899d900089999000899d900089989000898f900898ff890
-- 032:0111111001444440349c49c034cc3cc00344444047664674077777700f800f80
-- </SPRITES>

-- <MAP>
-- 003:000000001000200030004000500060007000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- </MAP>

-- <WAVES>
-- 000:00000000ffffffff00000000ffffffff
-- 001:0123456789abcdeffedcba9876543210
-- 002:0123456789abcdef0123456789abcdef
-- </WAVES>

-- <SFX>
-- 000:000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000304000000000
-- </SFX>

-- <FLAGS>
-- 000:00142434445474845b94000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000003000303030303000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 001:10000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- </FLAGS>

-- <PALETTE>
-- 000:1a1c2c5d275db13e53ef7d57ffcd75a7f07038b76425717929366f3b5dc941a6f673eff7f4f4f494b0c2566c86333c57
-- </PALETTE>

