-- title:  Turtle Burgle
-- author: Nathan Jent
-- desc:   We're here to burgle your turts!
-- script: moon

FLGREG=0x14404

lerp=(a,b,t)->(1-t)*a + t*b

-- flag as byte
fget8=(id)->peek FLGREG+id
fset8=(id,val)->poke FLGREG+id,val

-- flag as nibble
fget4=(id,top)->
	peek (top and 4 or 0)+FLGREG+id
fset4=(id,top,val)->
	poke (top and 4 or 0)+FLGREG+id

class Entity
	new:(o)=>
		@x=o and o.x or 10
		@y=o and o.y or 10
		@w=o and o.w or 8
		@h=o and o.h or 8
		@aim=o and o.aim or 0
		@rotate=o and o.rotate or 0
		@scale=o and o.scale or 1
		@state=o and o.state or "idle"
		@sprt=
			id:o and o.sprt and o.sprt.id or 1
			t:o and o.sprt and o.sprt.t or 0
			w:o and o.sprt and o.sprt.w or 1
			h:o and o.sprt and o.sprt.h or 1
			statedata:o and o.sprt and o.sprt.statedata

t=0
cam=
	x:120
	y:64
p=Entity {
	w:8
	h:16
	sprt:
		id:256
		w:1
		h:2
		statedata:
			walking:
				rate:6
				frames:{256,257}
			idle:
				frames:{256}
}
buddy=Entity {
	sprt:
		id:288
}
item=Entity {
	sprt:
		id:0
}
bullets={}

-- draw object adjusted to camera view
draw=(o,c,t)->
	id=o.sprt.id
	if o.state and o.sprt.statedata
		state=o.sprt.statedata[o.state]
		if state.frames and state.rate
			id=state.frames[state.current or 1]
			if (t%60)%state.rate==0
				state.current=state.current and state.current+1 or 1
				if state.current>#state.frames
					state.current=1
	spr id,o.x+c.x,o.y+c.y,
		o.sprt.t,o.scale,o.aim==2 and 1 or 0,o.rotate,
		o.sprt.w,o.sprt.h

-- Get map location from player coordinates
cammapget=(c,x,y)->
	(c.x%8+x)//8+15,(c.y%8+y)//8+8

export TIC=->
	p.state="idle"
	if btn 0
		p.y-=1
		p.aim=0
		p.state="walking"
	if btn 1
		p.y+=1
		p.aim=1
		p.state="walking"
	if btn 2
		p.x-=1
		p.aim=2
		p.state="walking"
	if btn 3
		p.x+=1
		p.aim=3
		p.state="walking"

	cam.x=math.min 120,lerp(cam.x,120-p.x,0.05)
	cam.y=math.min 64,lerp(cam.y,64-p.y,0.05)
	ccx=cam.x/8+(cam.x%8==0 and 1 or 0)
	ccy=cam.y/8+(cam.y%8==0 and 1 or 0)

	-- Get item from map location if flag is set
	mx,my = cammapget cam,p.x+p.w/2,p.y+p.h*3/4
	sprt=mget mx,my
	if 0 < fget8 sprt
		item.sprt.id=sprt

	buddy.aim=p.aim
	if p.aim==0
		buddy.y=lerp(p.y,buddy.x,.03)+10+math.sin t/9
	else
		buddy.y=lerp(p.y,buddy.x,.03)+6+math.sin t/9
	if p.aim==2
		buddy.x=lerp(p.x,buddy.x,.9)+1
	else
		buddy.x=lerp(p.x,buddy.x,.9)-1

	if item.sprt.id>0 and btnp 4,15,9
		table.insert bullets,Entity {
			x:buddy.x
			y:buddy.y-6
			aim:buddy.aim
			sprt:
				id:fget8 item.sprt.id
		}

	for i,b in pairs bullets
		if b.aim==2
			b.x-=2
		else
			b.x+=2
		b.rotate+=.2
		if b.x+cam.x>240 or b.x+cam.x<0
			table.remove bullets,i

	cls!
	map 15-ccx,8-ccy,31,18,(cam.x%8)-8,(cam.y%8)-8,0
	draw p,cam,t
	draw buddy,cam,t
	for b in *bullets
		draw b,cam,t
	
	print "sprite:#{sprt}",1,1,4
	print "item:#{item.sprt.id}",1,8,4
	print "player x:#{p.x} y:#{p.y}",1,16,4
	print "buddy x:#{buddy.x} y:#{buddy.y}",1,24,4
	print "camera x:#{cam.x} y:#{cam.y}",1,32,4
	print "map x:#{mx} y:#{my}",1,40,4
	t+=1

-- <TILES>
-- 001:023333300233333002cf3cf0023333300eddddd00ffffff00eddddd00fe00fe0
-- 002:0000000000000000000000000000006600777066077777600777776000600600
-- 003:09a009a09aaaaaab944aa44b9aaaaaab9dccccdb9dccccdb99aaaaab009aba00
-- 004:008990000899999089999999084a4a4008444443088888830888888388888883
-- 005:0233330023333330334a4a303344443003f7770000f767000f77667000200200
-- 006:0012220001122220034a4a400344444000342400038999400089990000770660
-- 007:0000666000006f60000066440666660066666600077766000003000000033300
-- 016:0000000000000000000000000000000000222066022222663333336006000600
-- 017:0006600060033006063223600322223003222230032222300632236060033006
-- 018:00000000000000000000000000066600706f6f60076555670076667067770776
-- 128:0000000000400000000330400432230000323300000330400040000000000000
-- 130:0000043200004320000032000001100000011000002300000234000023400000
-- 131:c00000c00000c000000000000c0000000000c00000000000000c00000c00000c
-- 132:0040000044444000044400000404000000000400000444440000444000004040
-- 133:00c0eed00c0eeed0c0eeeed00000200000002000000020000000200000002000
-- 134:000000000000cc00000ccbc000ccccbc00cccccc00dccccc00edcccd000eddd0
-- 208:0000000000000777000777770077777700777777077777770777777707777777
-- 209:0000000077777777777777777777777777777777777777777777777777777777
-- 210:0000000077000000777700007777700077777700777777007777777077777770
-- 224:0777777707777777077777770777777707777777077777770777777707777777
-- 225:7777777777777777777777777777777777777777777777777777777777777777
-- 226:7777777077777770777777707777777077777770777777707777777077777770
-- 240:0777777707777777077777770777777700777777000777770000077700000000
-- 241:7777777777777777777777777777777777777777777777777777777700000000
-- 242:7777777077777770777777707777777077777700777770007770000000000000
-- 252:fffffffff8888fff888888f88eeee888e8888eee888f888888fff888ffffffff
-- 253:0000000000d000000ded000000d000d000000ded000d00d000ded000000d0000
-- 254:1111111012000210102020101002001010202010120002101111111000000000
-- 255:0ddcccc00dccccc00dffcff00dccfcc00edcccd00ffffff00eddddd00fe00fe0
-- </TILES>

-- <SPRITES>
-- 000:02000000022200002222200022111100214444001444444034cf4cf034444340
-- 001:02000000022200002222200022111100214444001444444034cf4cf034444340
-- 016:03444400088999000899d900089999000899d900089989000898f900898ff890
-- 017:03444400088999000899d900089999000899d90008998900098ff89098ffff80
-- 032:0111111001444440349c49c034cc3cc00344444047664674077777700f800f80
-- </SPRITES>

-- <MAP>
-- 003:000000001000200030004000500060007000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 004:000000000000000000000000000000000000000000df00000000df000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 005:0000000000000000000000df000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 006:0000df000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 007:00000000000000000000000000000000000000000000000000000000df00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 008:cfcfcfcfcfcfcfcfcfcfcfcfcfcfcfcfcfcfcfcfcfcfcfcfcfcfcfcfcfcf000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 011:00df00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 014:00000000000000000000000000df000000000000df0000000000df000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 015:00000000df00000000000000000000000000000000000000000000000d1e1e1e1e1d2d00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 016:0000000000000000000000000000000000000000000000000000000d1e1e1e1e1e1e2e00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 017:00000000000000000000000000000000000000000000000000000d1e1e1e1e1e1e1e2e00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 018:00000000000000000000000000000000000000000000000000000e1e1e1e1e1e1e1e2e00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 019:00000000000000000000000000000000000000000000000000000f1e1e1e1e1e1e1e2e00400010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 020:0000000000000000000000000000000000000000000000000000000e1e1e1e1f1f1f2f00007000000000000000000000700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 021:0000000000000000000000000000000000000000000000000000000f1f1f2f0000000000500060000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 023:000000000000000000000000000000000000000000000000000000000000000000000030000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 024:000000000000000000000000000000000000000000000000000060000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 025:000000000000000000000000000000000000000000000000000000000000000000000000000000000000500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 028:000000000000000000000000000000000000000000000000000000000000000000000000400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- </MAP>

-- <WAVES>
-- 000:00000000ffffffff00000000ffffffff
-- 001:0123456789abcdeffedcba9876543210
-- 002:0123456789abcdef0123456789abcdef
-- </WAVES>

-- <SFX>
-- 000:000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000304000000000
-- </SFX>

-- <FLAGS>
-- 000:00081828384858685b94000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- </FLAGS>

-- <PALETTE>
-- 000:1a1c2c5d275db13e53ef7d57ffcd75a7f07038b76425717929366f3b5dc941a6f673eff7f4f4f494b0c2566c86333c57
-- </PALETTE>

